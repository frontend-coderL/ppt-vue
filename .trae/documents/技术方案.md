1. 项目背景
后台 AI 端生成 PPT，每页以 HTML 页面形式返回前端，前端需要构建一个在线 PPT 编辑器，实现多页渲染、元素选择、拖拽缩放、文本编辑、富文本编辑、样式调整、插入组件、演示等完整编辑能力。

2. 整体架构设计

采用 前端 SPA + iframe 隔离 PPT 内容 的方案。

为何使用 iframe：

AI 返回的 HTML 不可控（样式、脚本），需隔离 context，避免污染编辑器页面。

PPT 元素需要被编辑，需要在 iframe 内渲染生产环境样式，但由外层 editor 控制编辑态。

Moveable、Selecto 等支持跨 iframe 处理（事件捕获），可对 iframe 内元素包裹控制框。


3. 页面布局
3.1 顶部操作栏（固定）

插入文本

插入图片

插入空白页

根据选中元素动态显示：

区块元素工具栏：背景色、背景图、圆角、边框、阴影、margin/padding、对齐方式

文本元素工具栏：字体、字号、加粗、斜体、颜色、裁剪文字范围的编辑操作

右侧放“演示”按钮

3.2 主体区域（左右布局）
左侧：可选，缩略图列表  
右侧：垂直渲染 PPT 页面（多 iframe）


每页 iframe 高度等同真实 PPT 画布比例（默认 16:9）。

4. 核心功能设计
4.1 多页 PPT 渲染

AI 返回：

string[] htmlPages


前端策略：

每页构造 <iframe srcdoc="...">

加载完毕后注入以下脚本：

click 事件代理

mousemove 获取坐标

可选：禁用 PPT 页内交互

自动注册元素，使可选中、可编辑

4.2 元素选中与选中框

关键：使用 Moveable + Selecto
官方支持跨 iframe 操作。

实现：

4.2.1 点击元素 → 触发编辑态

iframe 内 click → postMessage 到父页面

父页面收到事件，找到对应真实 DOM（利用 iframe.contentWindow.document 查询）

Moveable 指向该 DOM，显示控制框

修改顶部工具栏（根据元素类型）

4.2.2 Moveable 提供的能力

draggable

resizable

scalable

rotatable

warpable（可选）

snap（对齐）

throttle（限制像素）

4.2.3 选中框对齐策略

移动时吸附到页面范围

resize 限制最小宽高

旋转 0/45/90 吸附

4.3 区块元素属性编辑

判断依据：

if (element instanceof HTMLDivElement || element instanceof HTMLElement && element.children.length > 0)


提供属性：

属性	方式
背景色	element.style.backgroundColor
背景图	element.style.backgroundImage
圆角	element.style.borderRadius
边框	element.style.border
阴影	element.style.boxShadow
对齐方式	element.style.textAlign / flex / absolute
margin/padding	element.style.xxx

实时更新：

工具栏修改 → 直接写入 iframe 内 DOM.style

Moveable 的坐标、尺寸变化同步写 style

4.4 文本元素编辑（重要）

文本元素分两种状态：

★ 选择元素状态（可移动、可调整大小）

此时不能编辑文字内容

顶部工具栏提供字体、字号、全局颜色、加粗等

修改的是整个元素的 style

★ 双击进入文本编辑状态（原地 contenteditable）

实现：

element.setAttribute('contenteditable', 'true')
element.focus()


退出：

点击外部 → 设为不可编辑

保存时清除 contenteditable

文本子范围操作（富文本编辑）
使用 Range / Selection API

步骤：

用户双击 → 进入 contenteditable

用户选中文字 → Selection API 获取 Range

工具栏的加粗、斜体等 → 执行 document.execCommand 或 自己包裹 <span>：

实现粗体：

const range = selection.getRangeAt(0)
const strong = iframeDoc.createElement('strong')
range.surroundContents(strong)


字体、字号同理：

span.style.fontSize = '20px'

可替代 execCommand：

推荐自定义实现，控制更强。

4.5 插入文本框

流程：

用户点击“插入文本”

Editor 进入“等待点击插入位置”模式

用户在 iframe 中任意位置 click

在 click 坐标处插入：

<div class="ppt-text" contenteditable="false"
     style="
        position:absolute; 
        left:${x}px; 
        top:${y}px;
        min-width:100px;
        min-height:40px;
     ">
  双击编辑文字
</div>


自动绑定 Moveable。

4.6 插入图片

类似文本框，流程：

点击“插入图片”

触发上传 input

得到 base64 或 URL

在用户点的位置插入：

<img src="..." style="position:absolute;width:200px;height:auto;">

4.7 新增空白页

插入页面模板：

<div class="slide-page" style="position:relative;width:100%;height:100%;">
</div>


生成新的 iframe。

4.8 保存（下载）与重置
保存：

遍历所有 iframe

获取 iframe.contentDocument.documentElement.outerHTML

打包为 zip 或单独下载

重置：

重新加载原始链接

清空编辑状态、删除 Moveable 框

4.9 PPT 演示模式

新开页面全屏演示：

每页按顺序展示

同样 iframe 渲染，但在静态状态下

使用全屏 API：

document.documentElement.requestFullscreen()


支持键盘翻页（← →）。

5. 关键技术方案
5.1 解决 iframe 内元素不会触发外层 Moveable 的问题

Moveable 官方支持跨 iframe 操作：

moveable.setIframe(iframe)


并使用：

moveable.frame = iframe.contentWindow;
moveable.target = iframe.contentDocument.querySelector(targetSelector)

5.2 解决 iframe 内点击事件无法传递的问题

注入脚本：

document.addEventListener('click', e => {
  window.parent.postMessage({
    type: 'ELEMENT_CLICK',
    path: getDomPath(e.target)
  }, '*')
})


外层 editor：

window.addEventListener('message', (e) => {
  if (e.data.type === 'ELEMENT_CLICK') {
     const el = getElementByPath(iframe, e.data.path)
     selectElement(el)
  }
})

5.3 富文本编辑范围覆盖正确方案

关键点：

选区只在当前 contenteditable 内生效

使用 Selection API 获得 Range

插入 span 或 strong 包裹

防止跨节点错误（需要 splitText）

可采用 Rangy（已不维护） → 推荐自研 Range 实现
（你之前已确认 Rangy 社区不活跃）

5.4 样式统一管理策略

建议禁用 iframe 内的外部 CSS，使用内联 CSS 保证可控：

对页面中所有元素进行格式化

强制设置 position:absolute 进行布局

在编辑器模式下添加辅助 CSS：

.outline-hover { outline: 1px dashed blue; }

6. 组件划分
components/
 ├── EditorHeaderToolbar/
 ├── SlideViewer/
 │    ├── SlideIframe.vue
 │    ├── MoveableController.vue
 │    └── SelectionHandler.vue
 ├── TextEditingToolbar.vue
 ├── BlockEditingToolbar.vue
 ├── InsertImageDialog.vue
 ├── InsertTextOverlay.vue
 └── PresentationMode.vue

7. 状态管理（Pinia）
7.1 当前选中元素状态
selectedElement: HTMLElement | null
selectedType: 'text' | 'block' | null
isEditingText: boolean
currentIframe: HTMLIFrameElement
selectionRange: Range | null

8. 性能优化

iframe 懒加载（只加载可视区域）

Moveable 只在选中时显示

工具栏与选中元素绑定使用 throttling

使用 requestAnimationFrame 来处理拖拽更新

9. 安全性考虑

禁用 iframe 内 JS 执行

过滤 AI HTML 中的 script/link

对 style 中 url() 做安全校验

禁止 contenteditable 粘贴包含脚本

10. 未来可扩展能力

动画编辑（进入/退出动画）

模板组件（图表、流程图）

团队协作多人编辑

导出为 PNG/PDF/PPTX

结语

以上方案完整覆盖你的需求：

多页 HTML 编辑

插入文本 / 图片

Moveable 编辑框

文本富文本编辑

区块样式编辑

演示模式

保存下载

重置

并提供清晰的架构、组件拆分、事件机制、iframe 方案、富文本实现策略，是可直接落地开发的工程级方案。